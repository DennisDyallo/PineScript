//@version=5
indicator("HMA Bands Exit Strategy", shorttitle="HMA Bands", overlay=true)

// ============================================================================
// HMA BANDS WITH VOLUME-CONFIRMED EXITS
// ============================================================================
// Simple, clean implementation without external library dependencies
// ============================================================================

// ============================= INPUTS =======================================

// HMA Parameters
hmaFast = input.int(21, "Fast HMA", minval=5, maxval=100, group="HMA Bands")
hmaSlow = input.int(55, "Slow HMA", minval=20, maxval=200, group="HMA Bands")
stdDevMult = input.float(2.0, "StdDev Multiplier", minval=0.5, maxval=5.0, step=0.1, group="HMA Bands")

// Volume Parameters
volPeriod = input.int(20, "Volume MA Period", minval=10, maxval=50, group="Volume")
volSpikeMin = input.float(1.5, "Min Volume Spike (150%)", minval=1.0, maxval=3.0, step=0.1, group="Volume")
volSpikeStrong = input.float(2.0, "Strong Volume Spike (200%)", minval=1.5, maxval=4.0, step=0.1, group="Volume")

// Display
showFill = input.bool(true, "Show Band Fill", group="Display")
showSlowHMA = input.bool(true, "Show Slow HMA", group="Display")
enableAlerts = input.bool(true, "Enable Alerts", group="Display")

// ============================= HMA CALCULATION ==============================

// Hull Moving Average function
f_hma(src, length) =>
    halfLen = length / 2
    sqrtLen = math.round(math.sqrt(length))
    wma1 = ta.wma(src, halfLen)
    wma2 = ta.wma(src, length)
    raw = 2 * wma1 - wma2
    ta.wma(raw, sqrtLen)

// Calculate HMAs
hmaFastLine = f_hma(close, hmaFast)
hmaSlowLine = f_hma(close, hmaSlow)

// Bollinger Bands around Fast HMA
basis = hmaFastLine
stdDev = ta.stdev(close, hmaFast) * stdDevMult
upperBand = basis + stdDev
lowerBand = basis - stdDev

// Band state
bandWidth = upperBand - lowerBand
isExpanding = bandWidth > ta.sma(bandWidth, 20)

// ============================= VOLUME ANALYSIS ==============================

avgVol = ta.sma(volume, volPeriod)
volRatio = volume / avgVol
isVolSpike = volRatio >= volSpikeMin
isStrongVolSpike = volRatio >= volSpikeStrong

// ============================= SIGNALS ======================================

// Bias
bullish = hmaFastLine > hmaSlowLine and hmaFastLine > hmaFastLine[1] and isExpanding
bearish = hmaFastLine < hmaSlowLine and hmaFastLine < hmaFastLine[1] and isExpanding

// Exit signals
longExit = close > upperBand and isVolSpike and barstate.isconfirmed
shortExit = close < lowerBand and isVolSpike and barstate.isconfirmed

// Strong exits
longExitStrong = close > upperBand and isStrongVolSpike and barstate.isconfirmed
shortExitStrong = close < lowerBand and isStrongVolSpike and barstate.isconfirmed

// HMA crossovers
hmaCrossUp = ta.crossover(hmaFastLine, hmaSlowLine)
hmaCrossDown = ta.crossunder(hmaFastLine, hmaSlowLine)

// ============================= VISUALIZATION ================================

// Plot bands (brighter colors for dark mode)
p1 = plot(hmaFastLine, "HMA 21", color=color.new(#2196F3, 0), linewidth=2)  // Bright blue
p2 = plot(showSlowHMA ? hmaSlowLine : na, "HMA 55", color=color.new(#9C27B0, 20), linewidth=1)  // Bright purple
plot(upperBand, "Upper Band", color=color.new(#00E676, 0), linewidth=2)  // Bright green
plot(lowerBand, "Lower Band", color=color.new(#FF5252, 0), linewidth=2)  // Bright red

// Fill between HMA 21 and HMA 55
hmaFillColor = hmaFastLine > hmaSlowLine ?
     color.new(#2196F3, 85) :  // Blue when fast > slow (bullish)
     color.new(#9C27B0, 85)    // Purple when slow > fast (bearish)
fill(p1, p2, hmaFillColor, title="HMA Fill")

// Band fill (more visible on dark backgrounds)
fillColor = showFill ?
     (bullish ? color.new(#00E676, 85) :  // Green with 85% transparency
      bearish ? color.new(#FF5252, 85) :  // Red with 85% transparency
      color.new(color.gray, 90)) : na
fill(plot(upperBand, display=display.none), plot(lowerBand, display=display.none), fillColor)

// Background (more visible - 92% transparency instead of 97%)
bgcolor(bullish ? color.new(#00E676, 92) : bearish ? color.new(#FF5252, 92) : na)

// Exit signals (bright colors for visibility)
plotshape(longExitStrong, "Long Exit (Strong)", shape.triangledown, location.abovebar,
     color.new(#FF5252, 0), size=size.normal, text="EXIT")
plotshape(shortExitStrong, "Short Exit (Strong)", shape.triangleup, location.belowbar,
     color.new(#00E676, 0), size=size.normal, text="EXIT")
plotshape(longExit and not longExitStrong, "Long Exit", shape.triangledown, location.abovebar,
     color.new(#FF5252, 0), size=size.small, text="EXIT")
plotshape(shortExit and not shortExitStrong, "Short Exit", shape.triangleup, location.belowbar,
     color.new(#00E676, 0), size=size.small, text="EXIT")

// Crossovers (bright colors)
plotshape(hmaCrossUp, "Bullish Cross", shape.circle, location.belowbar,
     color.new(#2196F3, 0), size=size.tiny)
plotshape(hmaCrossDown, "Bearish Cross", shape.circle, location.abovebar,
     color.new(#FF9800, 0), size=size.tiny)

// ============================= INFO TABLE ===================================

var table info = table.new(position.top_right, 2, 5, border_width=1)

if barstate.islast
    // Header
    table.cell(info, 0, 0, "HMA Bands", text_color=color.white,
         bgcolor=color.new(color.blue, 30), text_size=size.normal)
    table.merge_cells(info, 0, 0, 1, 0)

    // Bias
    table.cell(info, 0, 1, "Bias:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    biasText = bullish ? "BULLISH" : bearish ? "BEARISH" : "NEUTRAL"
    biasColor = bullish ? color.green : bearish ? color.red : color.gray
    table.cell(info, 1, 1, biasText, text_color=biasColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Volume
    table.cell(info, 0, 2, "Volume:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    volText = str.tostring(volRatio, "#.00") + "x"
    volColor = isStrongVolSpike ? color.green : isVolSpike ? color.yellow : color.gray
    table.cell(info, 1, 2, volText, text_color=volColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Band state
    table.cell(info, 0, 3, "Bands:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    bandText = isExpanding ? "EXPANDING" : "CONTRACTING"
    bandColor = isExpanding ? color.green : color.orange
    table.cell(info, 1, 3, bandText, text_color=bandColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Price position
    table.cell(info, 0, 4, "Price:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    pricePos = close > upperBand ? "ABOVE" : close < lowerBand ? "BELOW" : "INSIDE"
    priceColor = close > upperBand ? color.red : close < lowerBand ? color.green : color.gray
    table.cell(info, 1, 4, pricePos, text_color=priceColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

// ============================= ALERTS =======================================

if longExit and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("EXIT LONG - " + syminfo.ticker + " above upper band, volume: " + volStr, alert.freq_once_per_bar_close)

if shortExit and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("EXIT SHORT - " + syminfo.ticker + " below lower band, volume: " + volStr, alert.freq_once_per_bar_close)

if hmaCrossUp and enableAlerts
    alert("BULLISH CROSS - " + syminfo.ticker + " HMA 21 crossed above HMA 55", alert.freq_once_per_bar_close)

if hmaCrossDown and enableAlerts
    alert("BEARISH CROSS - " + syminfo.ticker + " HMA 21 crossed below HMA 55", alert.freq_once_per_bar_close)
