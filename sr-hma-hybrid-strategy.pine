//@version=5
indicator("SR + HMA Hybrid Strategy", shorttitle="SR+HMA", overlay=true, max_lines_count=150, max_labels_count=50)

// ============================================================================
// SR + HMA HYBRID TRADING STRATEGY
// ============================================================================
// ENTRY: Price at SR ensemble level (high agreement zones from 4 algorithms)
// BIAS: HMA bands determine trend direction (bullish/bearish/neutral)
// EXIT: Price closes beyond HMA bands + volume spike confirmation (150%+)
// CONFIRMATION: Multi-timeframe alignment + regime context
// ============================================================================
//
// CRITICAL FEATURES:
// 1. HMA Bands (21/55) with Bollinger-style deviation (2.0 stddev)
// 2. Volume spike detection (150% minimum, 200% strong)
// 3. Exit signals (price beyond bands + volume confirmation)
// 4. Multi-timeframe bias alignment
//
// HIGH PRIORITY FEATURES:
// 5. Alert system for exit signals
// 6. Band fill colors (bullish/bearish/neutral)
// 7. Info table (bias, volume, last signal)
// 8. Slow HMA confirmation line
// ============================================================================

// ============================= LIBRARY IMPORTS ==============================
import redshad0ww/CoreMath/1 as math_lib
import redshad0ww/VolumeAnalysis/1 as vol_lib
import redshad0ww/MTFUtils/2 as mtf_lib
import redshad0ww/RegimeDetection/2 as regime_lib

// ============================= INPUTS =======================================

// HMA Band Parameters
hmaFastLength = input.int(21, "Fast HMA Period", minval=5, maxval=100, group="HMA Bands")
hmaSlowLength = input.int(55, "Slow HMA Period", minval=20, maxval=200, group="HMA Bands")
bbStdDevMult = input.float(2.0, "Bollinger StdDev Multiplier", minval=0.5, maxval=5.0, step=0.1, group="HMA Bands")

// Volume Analysis Parameters
volMaPeriod = input.int(20, "Volume MA Period", minval=10, maxval=50, group="Volume")
volSpikeThreshold = input.float(1.5, "Volume Spike Threshold (150%)", minval=1.0, maxval=3.0, step=0.1, group="Volume", tooltip="Minimum volume spike to confirm exit (1.5 = 150% of average)")
volStrongThreshold = input.float(2.0, "Strong Volume Threshold (200%)", minval=1.5, maxval=4.0, step=0.1, group="Volume")

// Multi-Timeframe Parameters
showWeeklyHMA = input.bool(true, "Show Weekly HMA", group="Multi-Timeframe")
showMonthlyHMA = input.bool(true, "Show Monthly HMA", group="Multi-Timeframe")
weeklyHmaPeriod = input.int(20, "Weekly HMA Period", minval=10, maxval=100, group="Multi-Timeframe")
monthlyHmaPeriod = input.int(50, "Monthly HMA Period", minval=20, maxval=200, group="Multi-Timeframe")

// Display Parameters
showBandFill = input.bool(true, "Show Band Fill Colors", group="Display")
showMidLine = input.bool(true, "Show Middle Line (Fast HMA)", group="Display")
showSlowLine = input.bool(true, "Show Slow HMA Confirmation", group="Display")
showInfoTable = input.bool(true, "Show Info Table", group="Display")
enableAlerts = input.bool(true, "Enable Exit Alerts", group="Display")

// Regime Detection (optional context)
useRegimeFilter = input.bool(true, "Enable Regime Context", group="Regime")
atrLength = input.int(14, "ATR Length", minval=7, maxval=50, group="Regime")
atrLookback = input.int(50, "ATR Lookback", minval=20, maxval=100, group="Regime")

// ============================= CORE CALCULATIONS ============================

// HMA Calculations (using our library)
hmaFast = math_lib.calculateHMA(close, hmaFastLength)
hmaSlow = math_lib.calculateHMA(close, hmaSlowLength)

// Bollinger Bands around Fast HMA
basis = hmaFast
stdDev = math_lib.calculateStdDev(close, hmaFastLength) * bbStdDevMult
upperBand = basis + stdDev
lowerBand = basis - stdDev

// Band width for expansion/contraction detection
bandWidth = upperBand - lowerBand
bandWidthMA = ta.sma(bandWidth, 20)
isExpanding = bandWidth > bandWidthMA
isContracting = bandWidth <= bandWidthMA

// Volume Analysis (using our library)
volMetrics = vol_lib.calculateVolumeMetrics(volMaPeriod)
isVolSpike = vol_lib.isVolumeAboveThreshold(volMetrics, volSpikeThreshold)
isStrongSpike = vol_lib.isVolumeAboveThreshold(volMetrics, volStrongThreshold)
volMultiplier = volMetrics.relativeVolume

// Regime Detection (optional context)
regimeData = regime_lib.detectRegime(atrLength, atrLookback)
regimeName = regimeData.name
isHighVol = regimeData.isHighVol
isLowVol = regimeData.isLowVol

// ============================= MULTI-TIMEFRAME DATA =========================

// Weekly HMA
weeklyHMA = request.security(syminfo.tickerid, "W", math_lib.calculateHMA(close, weeklyHmaPeriod),
     lookahead=barmerge.lookahead_off)

// Monthly HMA
monthlyHMA = request.security(syminfo.tickerid, "M", math_lib.calculateHMA(close, monthlyHmaPeriod),
     lookahead=barmerge.lookahead_off)

// Weekly bias (fast vs slow HMA on weekly)
weeklyFastHMA = request.security(syminfo.tickerid, "W", math_lib.calculateHMA(close, hmaFastLength),
     lookahead=barmerge.lookahead_off)
weeklySlowHMA = request.security(syminfo.tickerid, "W", math_lib.calculateHMA(close, hmaSlowLength),
     lookahead=barmerge.lookahead_off)
weeklyBullish = weeklyFastHMA > weeklySlowHMA

// Monthly bias
monthlyFastHMA = request.security(syminfo.tickerid, "M", math_lib.calculateHMA(close, hmaFastLength),
     lookahead=barmerge.lookahead_off)
monthlySlowHMA = request.security(syminfo.tickerid, "M", math_lib.calculateHMA(close, hmaSlowLength),
     lookahead=barmerge.lookahead_off)
monthlyBullish = monthlyFastHMA > monthlySlowHMA

// ============================= SIGNAL DETECTION =============================

// Trend Bias Detection
bullishBias = hmaFast > hmaSlow and hmaFast > hmaFast[1] and isExpanding
bearishBias = hmaFast < hmaSlow and hmaFast < hmaFast[1] and isExpanding
neutralBias = not bullishBias and not bearishBias

// Exit Signal Conditions (CRITICAL)
// LONG EXIT: Price closes above upper band + volume spike
longExit = close > upperBand and isVolSpike and barstate.isconfirmed
longExitStrong = close > upperBand and isStrongSpike and barstate.isconfirmed

// SHORT EXIT: Price closes below lower band + volume spike
shortExit = close < lowerBand and isVolSpike and barstate.isconfirmed
shortExitStrong = close < lowerBand and isStrongSpike and barstate.isconfirmed

// Twist signal (HMA crossover - potential reversal)
hmaTwist = ta.cross(hmaFast, hmaSlow)
hmaTwistBullish = ta.crossover(hmaFast, hmaSlow)
hmaTwistBearish = ta.crossunder(hmaFast, hmaSlow)

// Multi-timeframe alignment
mtfAligned = (bullishBias and weeklyBullish and monthlyBullish) or
             (bearishBias and not weeklyBullish and not monthlyBullish)
mtfConflict = (bullishBias and not weeklyBullish) or (bearishBias and weeklyBullish)

// ============================= VISUALIZATION ================================

// Plot HMA Bands
plot(showMidLine ? basis : na, "HMA 21 (Middle)", color=color.new(color.blue, 20), linewidth=2)
plot(showSlowLine ? hmaSlow : na, "HMA 55 (Slow)", color=color.new(color.purple, 30), linewidth=1, style=plot.style_line)
plot(upperBand, "Upper Band", color=color.new(color.green, 0), linewidth=2)
plot(lowerBand, "Lower Band", color=color.new(color.red, 0), linewidth=2)

// Plot MTF HMAs
plot(showWeeklyHMA ? weeklyHMA : na, "Weekly HMA", color=color.new(color.orange, 50), linewidth=2)
plot(showMonthlyHMA ? monthlyHMA : na, "Monthly HMA", color=color.new(color.yellow, 50), linewidth=2)

// Band Fill (HIGH PRIORITY)
bandFillColor = showBandFill ?
     (bullishBias ? color.new(color.green, 90) :
      bearishBias ? color.new(color.red, 90) :
      color.new(color.gray, 95)) : na
fill(plot(upperBand, display=display.none), plot(lowerBand, display=display.none), color=bandFillColor, title="Band Fill")

// Background color for bias
bgcolor(bullishBias ? color.new(color.green, 97) : bearishBias ? color.new(color.red, 97) : na, title="Bias Background")

// Plot Exit Signals (CRITICAL)
plotshape(longExit, title="Long Exit", style=shape.triangledown, location=location.abovebar,
     color=color.new(color.red, 0), size=isStrongSpike ? size.normal : size.small, text="EXIT")
plotshape(shortExit, title="Short Exit", style=shape.triangleup, location=location.belowbar,
     color=color.new(color.green, 0), size=isStrongSpike ? size.normal : size.small, text="EXIT")

// Plot HMA Twist (crossover signals)
plotshape(hmaTwistBullish, title="Bullish Twist", style=shape.circle, location=location.belowbar,
     color=color.new(color.blue, 30), size=size.tiny)
plotshape(hmaTwistBearish, title="Bearish Twist", style=shape.circle, location=location.abovebar,
     color=color.new(color.orange, 30), size=size.tiny)

// ============================= INFO TABLE (HIGH PRIORITY) ===================

if showInfoTable
    var table infoTable = table.new(position.top_right, 2, 10, border_width=1)

    if barstate.isconfirmed or barstate.islast
        // Header
        table.cell(infoTable, 0, 0, "SR + HMA Hybrid",
             text_color=color.white, bgcolor=color.new(color.blue, 30), text_size=size.normal)
        table.merge_cells(infoTable, 0, 0, 1, 0)

        // Daily Bias
        table.cell(infoTable, 0, 1, "Daily Bias:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        biasText = bullishBias ? "BULLISH" : bearishBias ? "BEARISH" : "NEUTRAL"
        biasColor = bullishBias ? color.green : bearishBias ? color.red : color.gray
        table.cell(infoTable, 1, 1, biasText, text_color=biasColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

        // Weekly Bias
        table.cell(infoTable, 0, 2, "Weekly Bias:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        weeklyText = weeklyBullish ? "BULLISH" : "BEARISH"
        weeklyColor = weeklyBullish ? color.green : color.red
        table.cell(infoTable, 1, 2, weeklyText, text_color=weeklyColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

        // Monthly Bias
        table.cell(infoTable, 0, 3, "Monthly Bias:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        monthlyText = monthlyBullish ? "BULLISH" : "BEARISH"
        monthlyColor = monthlyBullish ? color.green : color.red
        table.cell(infoTable, 1, 3, monthlyText, text_color=monthlyColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

        // MTF Alignment
        table.cell(infoTable, 0, 4, "MTF Alignment:", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        alignmentText = mtfAligned ? "ALIGNED" : mtfConflict ? "CONFLICT" : "PARTIAL"
        alignmentColor = mtfAligned ? color.green : mtfConflict ? color.red : color.yellow
        table.cell(infoTable, 1, 4, alignmentText, text_color=alignmentColor, bgcolor=color.new(color.gray, 80), text_size=size.small)

        // Volume Status
        table.cell(infoTable, 0, 5, "Volume:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        volText = str.tostring(volMultiplier, "#.00") + "x"
        volColor = isStrongSpike ? color.green : isVolSpike ? color.yellow : color.gray
        table.cell(infoTable, 1, 5, volText, text_color=volColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

        // Band State
        table.cell(infoTable, 0, 6, "Band State:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        bandStateText = isExpanding ? "EXPANDING" : "CONTRACTING"
        bandStateColor = isExpanding ? color.green : color.orange
        table.cell(infoTable, 1, 6, bandStateText, text_color=bandStateColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

        // Price Position
        table.cell(infoTable, 0, 7, "Price Position:", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        pricePos = close > upperBand ? "ABOVE UPPER" : close < lowerBand ? "BELOW LOWER" :
                   close > basis ? "ABOVE MID" : "BELOW MID"
        priceColor = close > upperBand ? color.red : close < lowerBand ? color.green : color.gray
        table.cell(infoTable, 1, 7, pricePos, text_color=priceColor, bgcolor=color.new(color.gray, 80), text_size=size.small)

        // Regime
        table.cell(infoTable, 0, 8, "Regime:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        regimeColor = isLowVol ? color.green : isHighVol ? color.red : color.orange
        table.cell(infoTable, 1, 8, regimeName, text_color=regimeColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

        // Last Signal
        var string lastSignal = "None"
        var int lastSignalBar = 0
        if longExit
            lastSignal := "LONG EXIT"
            lastSignalBar := bar_index
        if shortExit
            lastSignal := "SHORT EXIT"
            lastSignalBar := bar_index

        table.cell(infoTable, 0, 9, "Last Signal:", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        signalText = lastSignal + " (" + str.tostring(bar_index - lastSignalBar) + ")"
        signalColor = str.contains(lastSignal, "LONG") ? color.red : str.contains(lastSignal, "SHORT") ? color.green : color.gray
        table.cell(infoTable, 1, 9, signalText, text_color=signalColor, bgcolor=color.new(color.gray, 80), text_size=size.small)

// ============================= ALERTS (HIGH PRIORITY) =======================

// Exit Alerts
if longExit and enableAlerts
    volText = isStrongSpike ? str.tostring(volMultiplier, "#.00") + "x STRONG" : str.tostring(volMultiplier, "#.00") + "x"
    alert("EXIT LONG - " + syminfo.ticker + " closed above upper band with volume spike: " + volText, alert.freq_once_per_bar_close)

if shortExit and enableAlerts
    volText = isStrongSpike ? str.tostring(volMultiplier, "#.00") + "x STRONG" : str.tostring(volMultiplier, "#.00") + "x"
    alert("EXIT SHORT - " + syminfo.ticker + " closed below lower band with volume spike: " + volText, alert.freq_once_per_bar_close)

// Bias Reversal Alerts
if hmaTwistBullish and enableAlerts
    alert("BULLISH TWIST - " + syminfo.ticker + " HMA 21 crossed above HMA 55", alert.freq_once_per_bar_close)

if hmaTwistBearish and enableAlerts
    alert("BEARISH TWIST - " + syminfo.ticker + " HMA 21 crossed below HMA 55", alert.freq_once_per_bar_close)

// MTF Conflict Alert
if mtfConflict and mtfConflict != mtfConflict[1] and enableAlerts
    alert("MTF CONFLICT - " + syminfo.ticker + " daily bias conflicts with weekly trend", alert.freq_once_per_bar_close)
