//@version=5
indicator("MKN: HMA Bands + S/R Exit Strategy", shorttitle="MKN: HMA + S/R", overlay=true)

// ============================================================================
// HMA BANDS WITH VOLUME-CONFIRMED EXITS + S/R CONFLUENCE
// ============================================================================
// Combines exit timing (HMA bands) with exit location (S/R levels) for
// high-probability exits
//
// Uses standardized volume thresholds from VolumeAnalysis library v1.1
//
// FEATURES:
// • Regime-adaptive volume thresholds (ATR-based)
//   - High volatility: +20% thresholds → fewer false positives
//   - Low volatility: -15% thresholds → catches subtle moves
//   - Normal volatility: Standard thresholds
//
// • Asset class awareness
//   - Stock (6.5hr): Standard thresholds (1.3x/1.5x/2.0x)
//   - Crypto (24hr): Lower thresholds -15% (1.1x/1.3x/1.7x)
//   - Futures (23hr): Lower thresholds -10% (1.2x/1.4x/1.8x)
//
// • Volume tier classification
//   - Tier 0 (NORMAL): < 1.3x average volume
//   - Tier 1 (ELEVATED): 1.3x - 1.5x (above average)
//   - Tier 2 (HIGH): 1.5x - 2.0x (significant interest)
//   - Tier 3 (EXTREME): > 2.0x (major event/institutions)
//
// • S/R Confluence Integration (NEW)
//   - Imports up to 10 S/R levels from sr-algo5-ensemble.pine
//   - Enhanced signals occur only at HMA band + S/R confluence + volume
//   - Normal signals: HMA band + volume (basic exits)
//   - Enhanced signals: HMA band + S/R confluence + volume (optimal exits)
//   - Expected improvement: +10-15% exit accuracy
//
// HOW TO USE S/R INTEGRATION:
// 1. Add sr-algo5-ensemble.pine to the same chart
// 2. In this indicator's settings, go to "S/R Integration" section
// 3. Map each "S/R Level" input to the corresponding plot from sr-algo5-ensemble
//    - S/R Level 1 → Top S/R Level 1 (plot output from ensemble)
//    - S/R Level 2 → Top S/R Level 2 (plot output from ensemble)
//    - ... continue for all 10 levels
// 4. Adjust "S/R Confluence Tolerance %" if needed (default 1.5%)
// 5. Enhanced signals (stars) will appear when HMA bands align with S/R levels
//
// Research-backed: Elder (2002), Harris (2003), Murphy (1999)
// ============================================================================

// ============================= LIBRARY IMPORTS ==============================
import redshad0ww/VolumeAnalysis/4 as vol_lib
import redshad0ww/RegimeDetection/3 as regime_lib

// ============================= INPUTS =======================================

// HMA Parameters
hmaFast = input.int(55, "Fast HMA", minval=5, maxval=100, group="HMA Bands")
hmaSlow = input.int(89, "Slow HMA", minval=20, maxval=200, group="HMA Bands")
stdDevMult = input.float(1.8, "StdDev Multiplier", minval=0.5, maxval=5.0, step=0.1, group="HMA Bands")

// Volume Parameters
volPeriod = input.int(20, "Volume MA Period", minval=10, maxval=50, group="Volume")

// Auto-detect asset type with manual override option
assetTypeInput = input.string("auto", "Asset Type", options=["auto", "stock", "crypto", "futures"],
     tooltip="Asset class for volume threshold adjustment:\n• Auto: Detect from symbol type\n• Stock (6.5hr): Standard thresholds\n• Crypto (24hr): Lower thresholds (-15%)\n• Futures (23hr): Lower thresholds (-10%)",
     group="Volume")

// Determine final asset type (auto-detect or use override)
assetType = assetTypeInput == "auto" ? (syminfo.type == "crypto" ? "crypto" : syminfo.type == "futures" ? "futures" : "stock") : assetTypeInput

// Display
showFill = input.bool(true, "Show Band Fill", group="Display")
showSlowHMA = input.bool(true, "Show Slow HMA", group="Display")
colorBars = input.bool(true, "Color Bars by HMA", group="Display")
enableAlerts = input.bool(true, "Enable Alerts", group="Display")

// S/R Integration
enableSRIntegration = input.bool(true, "Enable S/R Confluence Detection", group="S/R Integration",
     tooltip="Enable enhanced signals when HMA bands align with S/R levels from sr-algo5-ensemble")
srConfluenceTolerance = input.float(1.5, "S/R Confluence Tolerance (%)", minval=0.5, maxval=5.0, step=0.1, group="S/R Integration",
     tooltip="Maximum distance between price and S/R level to consider confluence (default 1.5%)")

// S/R Level Inputs (connect to sr-algo5-ensemble.pine outputs)
srLevel1 = input.source(close, "S/R Level 1", group="S/R Levels",
     tooltip="Connect to Top S/R Level 1 from sr-algo5-ensemble")
srLevel2 = input.source(close, "S/R Level 2", group="S/R Levels")
srLevel3 = input.source(close, "S/R Level 3", group="S/R Levels")
srLevel4 = input.source(close, "S/R Level 4", group="S/R Levels")
srLevel5 = input.source(close, "S/R Level 5", group="S/R Levels")
srLevel6 = input.source(close, "S/R Level 6", group="S/R Levels")
srLevel7 = input.source(close, "S/R Level 7", group="S/R Levels")
srLevel8 = input.source(close, "S/R Level 8", group="S/R Levels")
srLevel9 = input.source(close, "S/R Level 9", group="S/R Levels")
srLevel10 = input.source(close, "S/R Level 10", group="S/R Levels")

// ============================= HMA CALCULATION ==============================

// Calculate HMAs using built-in ta.hma() function
hmaFastLine = ta.hma(close, hmaFast)
hmaSlowLine = ta.hma(close, hmaSlow)

// Bollinger Bands around Fast HMA
basis = hmaFastLine
stdDev = ta.stdev(close, hmaFast) * stdDevMult
upperBand = basis + stdDev
lowerBand = basis - stdDev

// Band state
bandWidth = upperBand - lowerBand
isExpanding = bandWidth > ta.sma(bandWidth, 20)

// ============================= VOLUME ANALYSIS ==============================

// Calculate volume metrics using standardized library
volMetrics = vol_lib.calculateVolumeMetrics(volPeriod)
volRatio = volMetrics.relativeVolume

// Detect volatility regime
regime = regime_lib.detectRegime()

// Calculate regime-adjusted thresholds (adapts to volatility)
regimeThresholds = vol_lib.getRegimeAdjustedThresholds(regime.atrRatio)

// Calculate asset-adjusted thresholds (adapts to trading hours)
assetThresholds = vol_lib.getAssetAdjustedThresholds(assetType, regimeThresholds.low, regimeThresholds.medium, regimeThresholds.high)

// Get volume tier (0=normal, 1=elevated, 2=high, 3=extreme)
volTier = vol_lib.getVolumeTier(volRatio, assetThresholds.low, assetThresholds.medium, assetThresholds.high)

// Define spike flags based on tier
isVolSpike = volTier >= 2         // Tier 2+ (high or extreme volume)
isStrongVolSpike = volTier >= 3   // Tier 3 (extreme volume only)

// ============================= S/R CONFLUENCE DETECTION =====================

// Function to check if price is near any S/R level
checkSRConfluence(float price, float tolerance) =>
    // Convert tolerance from percentage to decimal
    toleranceDecimal = tolerance / 100.0

    // Check distance to each S/R level
    atSR = false
    if enableSRIntegration
        distance1 = math.abs(price - srLevel1) / price
        distance2 = math.abs(price - srLevel2) / price
        distance3 = math.abs(price - srLevel3) / price
        distance4 = math.abs(price - srLevel4) / price
        distance5 = math.abs(price - srLevel5) / price
        distance6 = math.abs(price - srLevel6) / price
        distance7 = math.abs(price - srLevel7) / price
        distance8 = math.abs(price - srLevel8) / price
        distance9 = math.abs(price - srLevel9) / price
        distance10 = math.abs(price - srLevel10) / price

        // Return true if any level is within tolerance
        atSR := distance1 <= toleranceDecimal or distance2 <= toleranceDecimal or distance3 <= toleranceDecimal or distance4 <= toleranceDecimal or distance5 <= toleranceDecimal or distance6 <= toleranceDecimal or distance7 <= toleranceDecimal or distance8 <= toleranceDecimal or distance9 <= toleranceDecimal or distance10 <= toleranceDecimal

    atSR

// Check if current price is at S/R confluence
atSRConfluence = checkSRConfluence(close, srConfluenceTolerance)

// ============================= SIGNALS ======================================

// Bias
bullish = hmaFastLine > hmaSlowLine and hmaFastLine > hmaFastLine[1] and isExpanding
bearish = hmaFastLine < hmaSlowLine and hmaFastLine < hmaFastLine[1] and isExpanding

// Buy/Sell signals (basic - HMA band + volume)
sellSignal = close > upperBand and isVolSpike and barstate.isconfirmed
buySignal = close < lowerBand and isVolSpike and barstate.isconfirmed

// Strong buy/sell signals (HMA band + extreme volume)
sellSignalStrong = close > upperBand and isStrongVolSpike and barstate.isconfirmed
buySignalStrong = close < lowerBand and isStrongVolSpike and barstate.isconfirmed

// Enhanced buy/sell signals (HMA band + volume + S/R confluence)
sellSignalEnhanced = sellSignal and atSRConfluence
buySignalEnhanced = buySignal and atSRConfluence
sellSignalStrongEnhanced = sellSignalStrong and atSRConfluence
buySignalStrongEnhanced = buySignalStrong and atSRConfluence

// HMA crossovers
hmaCrossUp = ta.crossover(hmaFastLine, hmaSlowLine)
hmaCrossDown = ta.crossunder(hmaFastLine, hmaSlowLine)

// ============================= VISUALIZATION ================================

// Plot bands with inverted colors on crossover (fancy gradient-inspired colors)
hmaFastColor = hmaFastLine > hmaSlowLine ? color.new(#00D9FF, 0) : color.new(#B57EDC, 0)  // Cyan when above, Lavender when below
hmaSlowColor = hmaFastLine > hmaSlowLine ? color.new(#B57EDC, 15) : color.new(#00D9FF, 15)  // Lavender when below fast, Cyan when above
p1 = plot(hmaFastLine, "HMA Fast", color=hmaFastColor, linewidth=2)
p2 = plot(showSlowHMA ? hmaSlowLine : na, "HMA Slow", color=hmaSlowColor, linewidth=1)
plot(upperBand, "Upper Band", color=color.new(#00FFA3, 70), linewidth=1)  // Mint green
plot(lowerBand, "Lower Band", color=color.new(#FF6B9D, 30), linewidth=1)  // Pink red

// Fill between HMA 55 and HMA 89 (gradient effect - unchanged)
hmaFillColor = hmaFastLine > hmaSlowLine ?
     color.new(#00D9FF, 40) :  // Cyan when fast > slow (bullish) - 60% opacity
     color.new(#B57EDC, 40)    // Lavender when slow > fast (bearish) - 60% opacity
fill(p1, p2, hmaFillColor, title="HMA Fill")

// Band fill (more visible on dark backgrounds)
fillColor = showFill ?
     (bullish ? color.new(#00E676, 90) :  // Green with 90% transparency
      bearish ? color.new(#FF5252, 90) :  // Red with 90% transparency
      color.new(color.gray, 95)) : na
fill(plot(upperBand, display=display.none), plot(lowerBand, display=display.none), fillColor)

// Background (subtle)
bgcolor(bullish ? color.new(#00E676, 95) : bearish ? color.new(#FF5252, 95) : na)

// Yellow bar detection: Volume spike (current or previous 2 bars) + close inside/crossing HMA band
// No consecutive yellows allowed - must exit band and re-enter to reset
hmaMin = math.min(hmaFastLine, hmaSlowLine)
hmaMax = math.max(hmaFastLine, hmaSlowLine)
hmaMinPrev = math.min(hmaFastLine[1], hmaSlowLine[1])
hmaMaxPrev = math.max(hmaFastLine[1], hmaSlowLine[1])

// Check if current close is inside HMA band
closeInsideBand = close >= hmaMin and close <= hmaMax

// Check if previous close was inside HMA band
prevCloseInsideBand = close[1] >= hmaMinPrev and close[1] <= hmaMaxPrev

// Check if close crossed to other side (was above → now inside/below, OR was below → now inside/above)
wasAboveBand = close[1] > hmaMaxPrev
wasBelowBand = close[1] < hmaMinPrev
crossedToOtherSide = (wasAboveBand and close <= hmaMax) or (wasBelowBand and close >= hmaMin)

// Check if price gapped from inside band to outside on other side
gappedOutOfBand = prevCloseInsideBand and (close > hmaMax or close < hmaMin)

// Volume spike in current or previous 2 bars
volSpikeInWindow = isVolSpike or isVolSpike[1] or isVolSpike[2]

// Check if close is outside the band (reset condition)
closeOutsideBand = close > hmaMax or close < hmaMin

// Check if price exited the band (was inside, now outside)
exitedBand = prevCloseInsideBand and closeOutsideBand

// Check if bar wicks through the band but doesn't close inside
wickThroughBand = not closeInsideBand and ((high >= hmaMin and high <= hmaMax) or (low >= hmaMin and low <= hmaMax))

// Check if bar opened inside band but closed outside (intrabar breakout)
openInsideCloseOutside = (open >= hmaMin and open <= hmaMax) and closeOutsideBand

// Check if current bar body is larger than previous bar body
currBodySize = math.abs(close - open)
prevBodySize = math.abs(close[1] - open[1])
isBodyLarger = currBodySize > prevBodySize

// Track reset: price was outside band since last yellow (or never had yellow yet)
var bool hasReset = true

// Yellow bar condition: (inside band OR crossed to other side OR gapped out OR exited band OR wick through OR intrabar breakout) AND volume spike AND reset occurred AND body larger than previous
isYellowBar = (closeInsideBand or crossedToOtherSide or gappedOutOfBand or exitedBand or wickThroughBand or openInsideCloseOutside) and volSpikeInWindow and hasReset and isBodyLarger

// Update reset state after calculating isYellowBar
if closeOutsideBand
    hasReset := true
else if isYellowBar
    hasReset := false  // Yellow triggered, lock until reset

// Bar coloring: Yellow for crossing HMA bands with volume spike
barcolor(colorBars ?
     (isYellowBar ? color.new(color.yellow, 0) :  // Yellow for crossing HMA bands with volume spike
      close > hmaFastLine ? color.new(#40ffa3, 0) : color.new(#ff3374, 0)) : na,
     title="HMA Bar Colors")

// Yellow background vertical for yellow bars (10% transparency)
bgcolor(isYellowBar ? color.new(color.yellow, 90) : na, title="Yellow Bar Background")

// Buy/Sell signals - Basic (triangles)
plotshape(sellSignalStrong and not sellSignalStrongEnhanced, "Sell Signal (Strong)", shape.triangledown, location.abovebar,
     color.new(#FF5252, 0), size=size.normal, text="SELL")
plotshape(buySignalStrong and not buySignalStrongEnhanced, "Buy Signal (Strong)", shape.triangleup, location.belowbar,
     color.new(#00E676, 0), size=size.normal, text="BUY")
plotshape(sellSignal and not sellSignalStrong and not sellSignalEnhanced, "Sell Signal", shape.triangledown, location.abovebar,
     color.new(#FF5252, 0), size=size.small, text="SELL")
plotshape(buySignal and not buySignalStrong and not buySignalEnhanced, "Buy Signal", shape.triangleup, location.belowbar,
     color.new(#00E676, 0), size=size.small, text="BUY")

// Enhanced signals - S/R Confluence (diamonds - brighter and larger)
plotshape(sellSignalStrongEnhanced, "Enhanced Sell (Strong + S/R)", shape.labeldown, location.abovebar,
     color.new(#ffffff, 0), size=size.large, text="SELL◆")
plotshape(buySignalStrongEnhanced, "Enhanced Buy (Strong + S/R)", shape.labelup, location.belowbar,
     color.new(#ffffff, 0), size=size.large, text="BUY◆")
plotshape(sellSignalEnhanced and not sellSignalStrongEnhanced, "Enhanced Sell (S/R)", shape.diamond, location.abovebar,
     color.new(#FF0000, 0), size=size.normal, text="SELL◆")
plotshape(buySignalEnhanced and not buySignalStrongEnhanced, "Enhanced Buy (S/R)", shape.diamond, location.belowbar,
     color.new(#00FF00, 0), size=size.normal, text="BUY◆")

// Crossovers (bright colors)
plotshape(hmaCrossUp, "Bullish Cross", shape.circle, location.belowbar,
     color.new(#5596F3, 0), size=size.tiny)
plotshape(hmaCrossDown, "Bearish Cross", shape.circle, location.abovebar,
     color.new(#FF9800, 0), size=size.tiny)

// ============================= INFO TABLE ===================================

var table info = table.new(position.top_right, 2, 7, border_width=1)

if barstate.islast
    // Header
    table.cell(info, 0, 0, "HMA + S/R", text_color=color.white,
         bgcolor=color.new(color.blue, 30), text_size=size.normal)
    table.merge_cells(info, 0, 0, 1, 0)

    // Bias
    table.cell(info, 0, 1, "Bias:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    biasText = bullish ? "BULLISH" : bearish ? "BEARISH" : "NEUTRAL"
    biasColor = bullish ? color.green : bearish ? color.red : color.gray
    table.cell(info, 1, 1, biasText, text_color=biasColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Volume (with tier classification)
    table.cell(info, 0, 2, "Volume:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    tierName = volTier == 3 ? "EXTREME" : volTier == 2 ? "HIGH" : volTier == 1 ? "ELEVATED" : "NORMAL"
    volText = str.tostring(volRatio, "#.00") + "x (" + tierName + ")"
    volColor = volTier == 3 ? color.red : volTier == 2 ? color.orange : volTier == 1 ? color.yellow : color.gray
    table.cell(info, 1, 2, volText, text_color=volColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Asset Type
    table.cell(info, 0, 3, "Asset:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    assetText = assetType == "crypto" ? "CRYPTO" : assetType == "futures" ? "FUTURES" : "STOCK"
    assetColor = assetType == "crypto" ? color.orange : assetType == "futures" ? color.yellow : color.blue
    table.cell(info, 1, 3, assetText, text_color=assetColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // S/R Confluence
    table.cell(info, 0, 4, "S/R:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    srText = atSRConfluence ? "YES" : "NO"
    srColor = atSRConfluence ? color.green : color.gray
    table.cell(info, 1, 4, srText, text_color=srColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Band state
    table.cell(info, 0, 5, "Bands:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    bandText = isExpanding ? "EXPANDING" : "CONTRACTING"
    bandColor = isExpanding ? color.green : color.orange
    table.cell(info, 1, 5, bandText, text_color=bandColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Price position
    table.cell(info, 0, 6, "Price:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    pricePos = close > upperBand ? "ABOVE" : close < lowerBand ? "BELOW" : "INSIDE"
    priceColor = close > upperBand ? color.red : close < lowerBand ? color.green : color.gray
    table.cell(info, 1, 6, pricePos, text_color=priceColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

// ============================= ALERTS =======================================

// Yellow bar alert
if isYellowBar and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("⚠ YELLOW BAR ⚠ - " + syminfo.ticker + " crossed HMA bands with volume spike (" + volStr + ") and expanding candle", alert.freq_once_per_bar_close)

// Enhanced signals (S/R confluence) - highest priority
if sellSignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED SELL (STRONG) ★ - " + syminfo.ticker + " at S/R + upper band + extreme volume: " + volStr, alert.freq_once_per_bar_close)

if buySignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED BUY (STRONG) ★ - " + syminfo.ticker + " at S/R + lower band + extreme volume: " + volStr, alert.freq_once_per_bar_close)

if sellSignalEnhanced and not sellSignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED SELL ★ - " + syminfo.ticker + " at S/R + upper band, volume: " + volStr, alert.freq_once_per_bar_close)

if buySignalEnhanced and not buySignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED BUY ★ - " + syminfo.ticker + " at S/R + lower band, volume: " + volStr, alert.freq_once_per_bar_close)

// Basic signals (no S/R confluence)
if sellSignal and not sellSignalEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("SELL SIGNAL - " + syminfo.ticker + " above upper band, volume: " + volStr, alert.freq_once_per_bar_close)

if buySignal and not buySignalEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("BUY SIGNAL - " + syminfo.ticker + " below lower band, volume: " + volStr, alert.freq_once_per_bar_close)

// HMA crossovers
if hmaCrossUp and enableAlerts
    alert("BULLISH CROSS - " + syminfo.ticker + " HMA Fast crossed above HMA Flow", alert.freq_once_per_bar_close)

if hmaCrossDown and enableAlerts
    alert("BEARISH CROSS - " + syminfo.ticker + " HMA Fast crossed below HMA Slow", alert.freq_once_per_bar_close)