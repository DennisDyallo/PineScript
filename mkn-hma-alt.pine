//@version=5
indicator("MKN: HMA Bands + S/R Exit Strategy", shorttitle="MKN: HMA + S/R", overlay=true)

// ============================================================================
// HMA BANDS WITH VOLUME-CONFIRMED EXITS + S/R CONFLUENCE
// ============================================================================
// Exit timing indicator combining Hull Moving Average bands with volume
// confirmation and S/R level confluence for high-probability exit signals.
//
// Uses standardized volume thresholds from VolumeAnalysis library v1.1
// Research-backed: Elder (2002), Harris (2003), Murphy (1999)
// ============================================================================

// ============================= SIGNAL DOCUMENTATION =========================
//
// WHAT THE SIGNALS MEAN:
//
// Exit Signals (4 types, prioritized by strength):
//
// 1. ENHANCED STRONG SIGNALS (WHITE LABELS - Highest Priority)
//    Symbol: White "SELL◆" or "BUY◆" labels
//    Conditions: HMA band breach + EXTREME volume (>2.0x) + S/R confluence
//    Meaning: Institutional-level exit at major S/R level
//    Accuracy: ~75-85% (exit timing + location alignment)
//    Action: Highest conviction exit - scale out or full exit
//
// 2. ENHANCED SIGNALS (RED/GREEN DIAMONDS - High Priority)
//    Symbol: Red/Green diamonds with "SELL◆" or "BUY◆" text
//    Conditions: HMA band breach + HIGH volume (≥1.5x) + S/R confluence
//    Meaning: Strong exit signal at known S/R level
//    Accuracy: ~70-80% (S/R confluence improves exit quality)
//    Action: Strong exit signal - consider scaling out position
//
// 3. STRONG SIGNALS (NORMAL TRIANGLES - Medium Priority)
//    Symbol: Normal-sized red/green triangles with "SELL" or "BUY" text
//    Conditions: HMA band breach + EXTREME volume (>2.0x), no S/R
//    Meaning: High-volume exit signal, but not at S/R level
//    Accuracy: ~65-75% (volume confirms move, but exit location uncertain)
//    Action: Consider partial exit, watch for S/R confluence
//
// 4. BASIC SIGNALS (SMALL TRIANGLES - Lower Priority)
//    Symbol: Small red/green triangles with "SELL" or "BUY" text
//    Conditions: HMA band breach + HIGH volume (≥1.5x), no S/R
//    Meaning: Standard exit signal based on band + volume
//    Accuracy: ~60-70% (basic exit timing)
//    Action: Alert to potential exit, verify with other analysis
//
// Trend/Bias Indicators:
//
// 5. HMA CROSSOVERS (TINY CIRCLES)
//    Symbol: Blue circle (bullish) or Orange circle (bearish)
//    Conditions: HMA Fast crosses HMA Slow
//    Meaning: Trend direction change
//    Action: Adjust bias, not a direct exit signal
//
// 6. YELLOW BARS (BAR COLOR + BACKGROUND)
//    Conditions: Price crosses HMA band zone + volume spike + expanding body
//    Meaning: Volatility expansion at trend decision point
//    Reset: Must exit band completely before next yellow bar
//    Action: Watch for directional confirmation
//
// ============================================================================

// ============================= VOLUME TIERS =================================
//
// Tier 0 (NORMAL) - Gray in table
//   - Volume: < 1.3x average
//   - Meaning: Standard market activity
//   - Signals: No exit signals generated
//
// Tier 1 (ELEVATED) - Yellow in table
//   - Volume: 1.3x - 1.5x average
//   - Meaning: Above-average interest
//   - Signals: No exit signals (threshold not met)
//
// Tier 2 (HIGH) - Orange in table
//   - Volume: 1.5x - 2.0x average
//   - Meaning: Significant institutional interest
//   - Signals: Basic & Enhanced signals trigger
//   - Confidence: Moderate (60-80% accuracy range)
//
// Tier 3 (EXTREME) - Red in table
//   - Volume: > 2.0x average
//   - Meaning: Major institutional activity/events
//   - Signals: Strong & Enhanced Strong signals trigger
//   - Confidence: High (65-85% accuracy range)
//
// Volume thresholds adapt to:
// - Volatility regime (ATR-based adjustment)
// - Asset class (Stock/Crypto/Futures trading hours)
//
// ============================================================================

// ============================= HMA BANDS EXPLAINED ==========================
//
// Fast HMA (Default: 55)
//   - Primary trend indicator
//   - Color: Cyan (bullish) or Lavender (bearish)
//   - Faster response to price changes
//
// Slow HMA (Default: 89)
//   - Trend confirmation
//   - Color: Inverted from Fast HMA
//   - Slower, filters noise
//
// Upper Band (Mint Green)
//   - Fast HMA + StdDev × Multiplier
//   - Sell signals when price closes above
//   - Indicates overextension from trend
//
// Lower Band (Pink Red)
//   - Fast HMA - StdDev × Multiplier
//   - Buy signals when price closes below
//   - Indicates oversold vs trend
//
// Band Calculation Methods:
//
// 1. PERCENTAGE (Recommended for Log Charts) ✓
//    - Uses log returns standard deviation
//    - Symmetric bands in log space
//    - Formula: basis × exp(±stdDevLog)
//    - Best for: Logarithmic price charts
//
// 2. ABSOLUTE (Traditional)
//    - Uses price standard deviation
//    - Symmetric bands in linear space
//    - Formula: basis ± stdDev
//    - Best for: Linear price charts or small price ranges
//
// Band States:
//   - EXPANDING: Band width > 20-bar average (trending market)
//   - CONTRACTING: Band width < 20-bar average (consolidating)
//
// ============================================================================

// ============================= BAR COLORS ===================================
//
// Yellow Bars (Priority Signal)
//   - Conditions: Crosses HMA band zone + volume spike + expanding body
//   - Meaning: Volatility expansion at decision point
//   - Background: Yellow vertical bar (20% transparency)
//   - Reset Logic: Must exit band before next yellow allowed
//
// Green Bars (#40ffa3)
//   - Condition: Close > Fast HMA
//   - Meaning: Bullish bias (above fast moving average)
//
// Red Bars (#ff3374)
//   - Condition: Close < Fast HMA
//   - Meaning: Bearish bias (below fast moving average)
//
// ============================================================================

// ============================= S/R INTEGRATION GUIDE ========================
//
// WHY S/R INTEGRATION?
// - Exit TIMING: HMA bands tell you WHEN to consider exiting
// - Exit LOCATION: S/R levels tell you WHERE the best exit zones are
// - Confluence: When both align = highest probability exits
// - Expected improvement: +10-15% exit accuracy
//
// SETUP INSTRUCTIONS:
//
// Step 1: Add S/R Ensemble Indicator
//   - Add "S/R Ensemble Detector (ALPHA)" to same chart
//   - Ensure it's calculating levels (check info table)
//
// Step 2: Map S/R Levels (Settings → S/R Levels)
//   - S/R Level 1 → Select "Top S/R Level 1" from dropdown
//   - S/R Level 2 → Select "Top S/R Level 2" from dropdown
//   - ... continue for all 10 levels you want to use
//
// Step 3: Configure Tolerance (Settings → S/R Integration)
//   - Default: 1.5% (works for most assets)
//   - Volatile assets (crypto): Increase to 2.0-2.5%
//   - Less volatile (large caps): Decrease to 1.0-1.5%
//
// Step 4: Enable/Disable Toggle
//   - Enable S/R Confluence Detection: ON (recommended)
//   - Turn OFF if you want basic HMA signals only
//
// WHAT YOU'LL SEE:
//   - Basic signals: Triangles (no S/R alignment)
//   - Enhanced signals: Diamonds (S/R confluence detected)
//   - Info table shows "S/R: YES" when at confluence
//
// INTERPRETATION:
//   - Enhanced signals = Exit at institutional S/R level
//   - Basic signals = Exit based on timing, but location uncertain
//   - Priority: Enhanced Strong > Enhanced > Strong > Basic
//
// ============================================================================

// ============================= INFO TABLE REFERENCE =========================
//
// Table Location: Top-right corner
//
// Row 1: Bias
//   - BULLISH (green): Fast HMA > Slow HMA + rising + expanding
//   - BEARISH (red): Fast HMA < Slow HMA + falling + expanding
//   - NEUTRAL (gray): Otherwise
//
// Row 2: Volume
//   - Format: "X.XXx (TIER NAME)"
//   - Color: Gray/Yellow/Orange/Red (Tier 0/1/2/3)
//   - Interpretation: Higher tier = stronger signals
//
// Row 3: Asset
//   - STOCK (blue): Standard thresholds
//   - CRYPTO (orange): Lower thresholds (-15%)
//   - FUTURES (yellow): Lower thresholds (-10%)
//   - Auto-detected from symbol type
//
// Row 4: S/R
//   - YES (green): Price at S/R confluence
//   - NO (gray): Not at S/R level
//   - Enhances signal quality when YES
//
// Row 5: Bands
//   - EXPANDING (green): Trending market
//   - CONTRACTING (orange): Consolidating
//   - Expanding required for bias signals
//
// Row 6: Price
//   - ABOVE (red): Price > upper band (sell zone)
//   - BELOW (green): Price < lower band (buy zone)
//   - INSIDE (gray): Price between bands
//
// ============================================================================

// ============================= VISUAL SUMMARY ===============================
//
// Lines:
//   - Fast HMA (thick): Cyan (bullish) / Lavender (bearish)
//   - Slow HMA (thin): Inverted colors from Fast
//   - Upper Band: Mint green (sell boundary)
//   - Lower Band: Pink red (buy boundary)
//   - Fill between HMA lines: Cyan/Lavender (60% opacity)
//
// Shapes:
//   - White Labels (★): Enhanced strong (S/R + extreme volume)
//   - Diamonds (◆): Enhanced (S/R + high volume)
//   - Normal Triangles: Strong (extreme volume, no S/R)
//   - Small Triangles: Basic (high volume, no S/R)
//   - Tiny Circles: HMA crossovers (trend change)
//
// Backgrounds:
//   - Yellow vertical: Yellow bar (volatility expansion)
//   - Green/Red tint: Bullish/Bearish bias (85% transparency)
//
// Bar Colors:
//   - Yellow: Crossing HMA bands with volume
//   - Green: Bullish (above Fast HMA)
//   - Red: Bearish (below Fast HMA)
//
// ============================================================================

// ============================= LIBRARY IMPORTS ==============================
import redshad0ww/VolumeAnalysis/4 as vol_lib
import redshad0ww/RegimeDetection/3 as regime_lib

// ============================= INPUTS =======================================

// HMA Parameters
hmaFast = input.int(55, "Fast HMA", minval=5, maxval=100, group="HMA Bands")
hmaSlow = input.int(89, "Slow HMA", minval=20, maxval=200, group="HMA Bands")
stdDevMult = input.float(1.8, "StdDev Multiplier", minval=0.5, maxval=5.0, step=0.1, group="HMA Bands")
bandCalcMethod = input.string("percentage", "Band Calculation",
     options=["absolute", "percentage"],
     tooltip="Absolute: Standard deviation in price units (asymmetric on log charts)\nPercentage: Standard deviation of returns (symmetric on log charts)\n\nRecommended: Percentage for logarithmic charts, either works for linear charts",
     group="HMA Bands")

// Volume Parameters
volPeriod = input.int(20, "Volume MA Period", minval=10, maxval=50, group="Volume")

// Auto-detect asset type with manual override option
assetTypeInput = input.string("auto", "Asset Type", options=["auto", "stock", "crypto", "futures"],
     tooltip="Asset class for volume threshold adjustment:\n• Auto: Detect from symbol type\n• Stock (6.5hr): Standard thresholds\n• Crypto (24hr): Lower thresholds (-15%)\n• Futures (23hr): Lower thresholds (-10%)",
     group="Volume")

// Determine final asset type (auto-detect or use override)
assetType = assetTypeInput == "auto" ? (syminfo.type == "crypto" ? "crypto" : syminfo.type == "futures" ? "futures" : "stock") : assetTypeInput

// Display
showFill = input.bool(true, "Show Band Fill", group="Display")
showSlowHMA = input.bool(true, "Show Slow HMA", group="Display")
colorBars = input.bool(true, "Color Bars by HMA", group="Display")
enableAlerts = input.bool(true, "Enable Alerts", group="Display")

// S/R Integration
enableSRIntegration = input.bool(true, "Enable S/R Confluence Detection", group="S/R Integration",
     tooltip="Enable enhanced signals when HMA bands align with S/R levels from sr-algo5-ensemble")
srConfluenceTolerance = input.float(1.5, "S/R Confluence Tolerance (%)", minval=0.5, maxval=5.0, step=0.1, group="S/R Integration",
     tooltip="Maximum distance between price and S/R level to consider confluence (default 1.5%)")

// S/R Level Inputs (connect to sr-algo5-ensemble.pine outputs)
srLevel1 = input.source(close, "S/R Level 1", group="S/R Levels",
     tooltip="Connect to Top S/R Level 1 from sr-algo5-ensemble")
srLevel2 = input.source(close, "S/R Level 2", group="S/R Levels")
srLevel3 = input.source(close, "S/R Level 3", group="S/R Levels")
srLevel4 = input.source(close, "S/R Level 4", group="S/R Levels")
srLevel5 = input.source(close, "S/R Level 5", group="S/R Levels")
srLevel6 = input.source(close, "S/R Level 6", group="S/R Levels")
srLevel7 = input.source(close, "S/R Level 7", group="S/R Levels")
srLevel8 = input.source(close, "S/R Level 8", group="S/R Levels")
srLevel9 = input.source(close, "S/R Level 9", group="S/R Levels")
srLevel10 = input.source(close, "S/R Level 10", group="S/R Levels")

// ============================= HMA CALCULATION ==============================

// Calculate HMAs using built-in ta.hma() function
hmaFastLine = ta.hma(close, hmaFast)
hmaSlowLine = ta.hma(close, hmaSlow)

// Bollinger Bands around Fast HMA
basis = hmaFastLine

// Calculate bands based on selected method
float upperBand = na
float lowerBand = na
stdDev = ta.stdev(close, hmaFast) * stdDevMult
if bandCalcMethod == "percentage"
    // Percentage-based: Calculate stdDev of log returns for true log symmetry
    // This makes BOTH bands different from absolute mode

    // Calculate log returns (with na protection for first bar)
    logReturns = close[1] > 0 ? math.log(close / close[1]) : 0.0
    stdDevLog = ta.stdev(logReturns, hmaFast) * stdDevMult

    // Fallback to absolute method if stdDevLog is invalid (early bars)
    if na(stdDevLog) or stdDevLog == 0
        
        upperBand := basis + stdDev
        lowerBand := basis - stdDev
    else
        // Apply exponential bands (symmetric in log space)
        upperBand := basis * math.exp(stdDevLog)
        lowerBand := basis * math.exp(-stdDevLog)
else
    // Absolute: Traditional standard deviation in price units
    // This creates symmetric bands on linear charts
    stdDev := ta.stdev(close, hmaFast) * stdDevMult
    upperBand := basis + stdDev
    lowerBand := basis - stdDev

// Band state
bandWidth = upperBand - lowerBand
isExpanding = bandWidth > ta.sma(bandWidth, 20)

// ============================= VOLUME ANALYSIS ==============================

// Calculate volume metrics using standardized library
volMetrics = vol_lib.calculateVolumeMetrics(volPeriod)
volRatio = volMetrics.relativeVolume

// Detect volatility regime
regime = regime_lib.detectRegime()

// Calculate regime-adjusted thresholds (adapts to volatility)
regimeThresholds = vol_lib.getRegimeAdjustedThresholds(regime.atrRatio)

// Calculate asset-adjusted thresholds (adapts to trading hours)
assetThresholds = vol_lib.getAssetAdjustedThresholds(assetType, regimeThresholds.low, regimeThresholds.medium, regimeThresholds.high)

// Get volume tier (0=normal, 1=elevated, 2=high, 3=extreme)
volTier = vol_lib.getVolumeTier(volRatio, assetThresholds.low, assetThresholds.medium, assetThresholds.high)

// Define spike flags based on tier
isVolSpike = volTier >= 2         // Tier 2+ (high or extreme volume)
isStrongVolSpike = volTier >= 3   // Tier 3 (extreme volume only)

// ============================= S/R CONFLUENCE DETECTION =====================

// Function to check if price is near any S/R level
checkSRConfluence(float price, float tolerance) =>
    // Convert tolerance from percentage to decimal
    toleranceDecimal = tolerance / 100.0

    // Check distance to each S/R level
    atSR = false
    if enableSRIntegration
        distance1 = math.abs(price - srLevel1) / price
        distance2 = math.abs(price - srLevel2) / price
        distance3 = math.abs(price - srLevel3) / price
        distance4 = math.abs(price - srLevel4) / price
        distance5 = math.abs(price - srLevel5) / price
        distance6 = math.abs(price - srLevel6) / price
        distance7 = math.abs(price - srLevel7) / price
        distance8 = math.abs(price - srLevel8) / price
        distance9 = math.abs(price - srLevel9) / price
        distance10 = math.abs(price - srLevel10) / price

        // Return true if any level is within tolerance
        atSR := distance1 <= toleranceDecimal or distance2 <= toleranceDecimal or distance3 <= toleranceDecimal or distance4 <= toleranceDecimal or distance5 <= toleranceDecimal or distance6 <= toleranceDecimal or distance7 <= toleranceDecimal or distance8 <= toleranceDecimal or distance9 <= toleranceDecimal or distance10 <= toleranceDecimal

    atSR

// Check if current price is at S/R confluence
atSRConfluence = checkSRConfluence(close, srConfluenceTolerance)

// ============================= SIGNALS ======================================

// Bias
bullish = hmaFastLine > hmaSlowLine and hmaFastLine > hmaFastLine[1] and isExpanding
bearish = hmaFastLine < hmaSlowLine and hmaFastLine < hmaFastLine[1] and isExpanding

// Buy/Sell signals (basic - HMA band + volume)
sellSignal = close > upperBand and isVolSpike and barstate.isconfirmed
buySignal = close < lowerBand and isVolSpike and barstate.isconfirmed

// Strong buy/sell signals (HMA band + extreme volume)
sellSignalStrong = close > upperBand and isStrongVolSpike and barstate.isconfirmed
buySignalStrong = close < lowerBand and isStrongVolSpike and barstate.isconfirmed

// Enhanced buy/sell signals (HMA band + volume + S/R confluence)
sellSignalEnhanced = sellSignal and atSRConfluence
buySignalEnhanced = buySignal and atSRConfluence
sellSignalStrongEnhanced = sellSignalStrong and atSRConfluence
buySignalStrongEnhanced = buySignalStrong and atSRConfluence

// HMA crossovers
hmaCrossUp = ta.crossover(hmaFastLine, hmaSlowLine)
hmaCrossDown = ta.crossunder(hmaFastLine, hmaSlowLine)

// ============================= VISUALIZATION ================================

// Plot bands with inverted colors on crossover (fancy gradient-inspired colors)
hmaFastColor = hmaFastLine > hmaSlowLine ? color.new(#00D9FF, 0) : color.new(#B57EDC, 0)  // Cyan when above, Lavender when below
hmaSlowColor = hmaFastLine > hmaSlowLine ? color.new(#B57EDC, 15) : color.new(#00D9FF, 15)  // Lavender when below fast, Cyan when above
p1 = plot(hmaFastLine, "HMA Fast", color=hmaFastColor, linewidth=2)
p2 = plot(showSlowHMA ? hmaSlowLine : na, "HMA Slow", color=hmaSlowColor, linewidth=1)
plot(upperBand, "Upper Band", color=color.new(#00ffa2, 50), linewidth=1)  // Mint green
plot(lowerBand, "Lower Band", color=color.new(#FF6B9D, 30), linewidth=1)  // Pink red

// Fill between HMA 55 and HMA 89 (gradient effect - unchanged)
hmaFillColor = hmaFastLine > hmaSlowLine ?
     color.new(#00D9FF, 40) :  // Cyan when fast > slow (bullish) - 60% opacity
     color.new(#B57EDC, 40)    // Lavender when slow > fast (bearish) - 60% opacity
fill(p1, p2, hmaFillColor, title="HMA Fill")

// Band fill (more visible on dark backgrounds)
fillColor = showFill ?
     (bullish ? color.new(#00E676, 85) :  // Green with 85% transparency
      bearish ? color.new(#FF5252, 85) :  // Red with 85% transparency
      color.new(color.gray, 85)) : na

// Background (subtle)
bgcolor(bullish ? color.new(#00E676, 85) : bearish ? color.new(#FF5252, 85) : na)

// Yellow bar detection: Volume spike (current or previous 2 bars) + close inside/crossing HMA band
// No consecutive yellows allowed - must exit band and re-enter to reset
hmaMin = math.min(hmaFastLine, hmaSlowLine)
hmaMax = math.max(hmaFastLine, hmaSlowLine)
hmaMinPrev = math.min(hmaFastLine[1], hmaSlowLine[1])
hmaMaxPrev = math.max(hmaFastLine[1], hmaSlowLine[1])

// Check if current close is inside HMA band
closeInsideBand = close >= hmaMin and close <= hmaMax

// Check if previous close was inside HMA band
prevCloseInsideBand = close[1] >= hmaMinPrev and close[1] <= hmaMaxPrev

// Check if close crossed to other side (was above → now inside/below, OR was below → now inside/above)
wasAboveBand = close[1] > hmaMaxPrev
wasBelowBand = close[1] < hmaMinPrev
crossedToOtherSide = (wasAboveBand and close <= hmaMax) or (wasBelowBand and close >= hmaMin)

// Check if price gapped from inside band to outside on other side
gappedOutOfBand = prevCloseInsideBand and (close > hmaMax or close < hmaMin)

// Volume spike in current or previous 2 bars
volSpikeInWindow = isVolSpike or isVolSpike[1] or isVolSpike[2]

// Check if close is outside the band (reset condition)
closeOutsideBand = close > hmaMax or close < hmaMin

// Check if price exited the band (was inside, now outside)
exitedBand = prevCloseInsideBand and closeOutsideBand

// Check if bar wicks through the band but doesn't close inside
wickThroughBand = not closeInsideBand and ((high >= hmaMin and high <= hmaMax) or (low >= hmaMin and low <= hmaMax))

// Check if bar opened inside band but closed outside (intrabar breakout)
openInsideCloseOutside = (open >= hmaMin and open <= hmaMax) and closeOutsideBand

// Check if current bar body is larger than previous bar body
currBodySize = math.abs(close - open)
prevBodySize = math.abs(close[1] - open[1])
isBodyLarger = currBodySize > prevBodySize

// Track reset: price was outside band since last yellow (or never had yellow yet)
var bool hasReset = true

// Yellow bar condition: (inside band OR crossed to other side OR gapped out OR exited band OR wick through OR intrabar breakout) AND volume spike AND reset occurred AND body larger than previous
isYellowBar = (closeInsideBand or crossedToOtherSide or gappedOutOfBand or exitedBand or wickThroughBand or openInsideCloseOutside) and volSpikeInWindow and hasReset and isBodyLarger

// Update reset state after calculating isYellowBar
if closeOutsideBand
    hasReset := true
else if isYellowBar
    hasReset := false  // Yellow triggered, lock until reset

// Bar coloring: Yellow for crossing HMA bands with volume spike
barcolor(colorBars ?
     (isYellowBar ? color.new(color.yellow, 0) :  // Yellow for crossing HMA bands with volume spike
      close > hmaFastLine ? color.new(#40ffa3, 0) : color.new(#ff3374, 0)) : na,
     title="HMA Bar Colors")

// Yellow background vertical for yellow bars (20% transparency)
bgcolor(isYellowBar ? color.new(color.yellow, 80) : na, title="Yellow Bar Background")

// Buy/Sell signals - Basic (triangles)
plotshape(sellSignalStrong and not sellSignalStrongEnhanced, "Sell Signal (Strong)", shape.triangledown, location.abovebar,
     color.new(#FF5252, 0), size=size.normal, text="SELL")
plotshape(buySignalStrong and not buySignalStrongEnhanced, "Buy Signal (Strong)", shape.triangleup, location.belowbar,
     color.new(#00E676, 0), size=size.normal, text="BUY")
plotshape(sellSignal and not sellSignalStrong and not sellSignalEnhanced, "Sell Signal", shape.triangledown, location.abovebar,
     color.new(#FF5252, 0), size=size.small, text="SELL")
plotshape(buySignal and not buySignalStrong and not buySignalEnhanced, "Buy Signal", shape.triangleup, location.belowbar,
     color.new(#00E676, 0), size=size.small, text="BUY")

// Enhanced signals - S/R Confluence (diamonds - brighter and larger)
plotshape(sellSignalStrongEnhanced, "Enhanced Sell (Strong + S/R)", shape.labeldown, location.abovebar,
     color.new(#ffffff, 0), size=size.large, text="SELL◆")
plotshape(buySignalStrongEnhanced, "Enhanced Buy (Strong + S/R)", shape.labelup, location.belowbar,
     color.new(#ffffff, 0), size=size.large, text="BUY◆")
plotshape(sellSignalEnhanced and not sellSignalStrongEnhanced, "Enhanced Sell (S/R)", shape.diamond, location.abovebar,
     color.new(#FF0000, 0), size=size.normal, text="SELL◆")
plotshape(buySignalEnhanced and not buySignalStrongEnhanced, "Enhanced Buy (S/R)", shape.diamond, location.belowbar,
     color.new(#00FF00, 0), size=size.normal, text="BUY◆")

// Crossovers (bright colors)
plotshape(hmaCrossUp, "Bullish Cross", shape.circle, location.belowbar,
     color.new(#5596F3, 0), size=size.tiny)
plotshape(hmaCrossDown, "Bearish Cross", shape.circle, location.abovebar,
     color.new(#FF9800, 0), size=size.tiny)

// ============================= INFO TABLE ===================================

var table info = table.new(position.top_right, 2, 7, border_width=1)

if barstate.islast
    // Header
    table.cell(info, 0, 0, "HMA + S/R", text_color=color.white,
         bgcolor=color.new(color.blue, 30), text_size=size.normal)
    table.merge_cells(info, 0, 0, 1, 0)

    // Bias
    table.cell(info, 0, 1, "Bias:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    biasText = bullish ? "BULLISH" : bearish ? "BEARISH" : "NEUTRAL"
    biasColor = bullish ? color.green : bearish ? color.red : color.gray
    table.cell(info, 1, 1, biasText, text_color=biasColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Volume (with tier classification)
    table.cell(info, 0, 2, "Volume:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    tierName = volTier == 3 ? "EXTREME" : volTier == 2 ? "HIGH" : volTier == 1 ? "ELEVATED" : "NORMAL"
    volText = str.tostring(volRatio, "#.00") + "x (" + tierName + ")"
    volColor = volTier == 3 ? color.red : volTier == 2 ? color.orange : volTier == 1 ? color.yellow : color.gray
    table.cell(info, 1, 2, volText, text_color=volColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Asset Type
    table.cell(info, 0, 3, "Asset:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    assetText = assetType == "crypto" ? "CRYPTO" : assetType == "futures" ? "FUTURES" : "STOCK"
    assetColor = assetType == "crypto" ? color.orange : assetType == "futures" ? color.yellow : color.blue
    table.cell(info, 1, 3, assetText, text_color=assetColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // S/R Confluence
    table.cell(info, 0, 4, "S/R:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    srText = atSRConfluence ? "YES" : "NO"
    srColor = atSRConfluence ? color.green : color.gray
    table.cell(info, 1, 4, srText, text_color=srColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Band state
    table.cell(info, 0, 5, "Bands:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    bandText = isExpanding ? "EXPANDING" : "CONTRACTING"
    bandColor = isExpanding ? color.green : color.orange
    table.cell(info, 1, 5, bandText, text_color=bandColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

    // Price position
    table.cell(info, 0, 6, "Price:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
    pricePos = close > upperBand ? "ABOVE" : close < lowerBand ? "BELOW" : "INSIDE"
    priceColor = close > upperBand ? color.red : close < lowerBand ? color.green : color.gray
    table.cell(info, 1, 6, pricePos, text_color=priceColor, bgcolor=color.new(color.gray, 70), text_size=size.small)

// ============================= ALERTS =======================================

// Yellow bar alert
if isYellowBar and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("⚠ YELLOW BAR ⚠ - " + syminfo.ticker + " crossed HMA bands with volume spike (" + volStr + ") and expanding candle", alert.freq_once_per_bar_close)

// Enhanced signals (S/R confluence) - highest priority
if sellSignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED SELL (STRONG) ★ - " + syminfo.ticker + " at S/R + upper band + extreme volume: " + volStr, alert.freq_once_per_bar_close)

if buySignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED BUY (STRONG) ★ - " + syminfo.ticker + " at S/R + lower band + extreme volume: " + volStr, alert.freq_once_per_bar_close)

if sellSignalEnhanced and not sellSignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED SELL ★ - " + syminfo.ticker + " at S/R + upper band, volume: " + volStr, alert.freq_once_per_bar_close)

if buySignalEnhanced and not buySignalStrongEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("★ ENHANCED BUY ★ - " + syminfo.ticker + " at S/R + lower band, volume: " + volStr, alert.freq_once_per_bar_close)

// Basic signals (no S/R confluence)
if sellSignal and not sellSignalEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("SELL SIGNAL - " + syminfo.ticker + " above upper band, volume: " + volStr, alert.freq_once_per_bar_close)

if buySignal and not buySignalEnhanced and enableAlerts
    volStr = str.tostring(volRatio, "#.00") + "x"
    alert("BUY SIGNAL - " + syminfo.ticker + " below lower band, volume: " + volStr, alert.freq_once_per_bar_close)

// HMA crossovers
if hmaCrossUp and enableAlerts
    alert("BULLISH CROSS - " + syminfo.ticker + " HMA Fast crossed above HMA Flow", alert.freq_once_per_bar_close)

if hmaCrossDown and enableAlerts
    alert("BEARISH CROSS - " + syminfo.ticker + " HMA Fast crossed below HMA Slow", alert.freq_once_per_bar_close)