//@version=5
indicator(title="Institutional Algo 2: Multi-Timeframe Volume Convergence", shorttitle="Inst MTF Convergence", overlay=false, precision=0)

// ============================================================================
// ALGORITHM 2: MULTI-TIMEFRAME VOLUME CONVERGENCE DETECTOR
// ============================================================================
// Identifies sustained institutional campaigns by detecting volume increases
// across multiple timeframes simultaneously
// ============================================================================

// ============================= INPUTS =======================================

// Timeframe Settings
currentTF = timeframe.period
manualHTF1 = input.timeframe("", "Higher Timeframe 1 (auto if empty)", group="Timeframe Settings",
     tooltip="Leave empty for auto-detection")
manualHTF2 = input.timeframe("", "Higher Timeframe 2 (auto if empty)", group="Timeframe Settings",
     tooltip="Leave empty for auto-detection")

// Volume Settings
volumeLookback = input.int(20, "Volume Lookback Period", minval=10, maxval=100, group="Volume Settings")
volumeThreshold1 = input.float(1.5, "Volume Threshold (Current TF)", minval=1.0, maxval=5.0, step=0.1, group="Volume Settings")
volumeThreshold2 = input.float(1.5, "Volume Threshold (HTF1)", minval=1.0, maxval=5.0, step=0.1, group="Volume Settings")
volumeThreshold3 = input.float(1.5, "Volume Threshold (HTF2)", minval=1.0, maxval=5.0, step=0.1, group="Volume Settings")

// Pattern Detection
divergenceThreshold = input.float(0.2, "Divergence Threshold (Price Range)", minval=0.0, maxval=1.0, step=0.05, group="Pattern Settings",
     tooltip="Max allowed price range vs avg for accumulation pattern")
trendLength = input.int(50, "Trend Detection Length", minval=20, maxval=200, group="Pattern Settings")

// Scoring Settings
scoreThreshold = input.int(70, "Score Threshold (Institutional)", minval=50, maxval=90, group="Scoring")

// Visualization Settings
showTable = input.bool(true, "Show Info Table", group="Visualization")
showMarkers = input.bool(true, "Show Chart Markers", group="Visualization")
showVolumePlots = input.bool(true, "Show Volume Plots", group="Visualization")

// Debug & Backtesting
debugMode = input.bool(false, "Debug Mode", group="Debug & Testing")
enableBacktest = input.bool(true, "Enable Backtesting", group="Debug & Testing")

// ============================= FUNCTIONS ====================================

// Function to auto-detect next logical timeframe
getHigherTimeframe(baseTF) =>
    string result = ""

    // Parse current timeframe
    tfInMinutes = timeframe.in_seconds(baseTF) / 60

    // Determine next timeframe
    if tfInMinutes <= 1
        result := "5"       // 1min -> 5min
    else if tfInMinutes <= 3
        result := "15"      // 3min -> 15min
    else if tfInMinutes <= 5
        result := "15"      // 5min -> 15min
    else if tfInMinutes <= 15
        result := "60"      // 15min -> 1hour
    else if tfInMinutes <= 30
        result := "60"      // 30min -> 1hour
    else if tfInMinutes <= 60
        result := "240"     // 1hour -> 4hour
    else if tfInMinutes <= 240
        result := "D"       // 4hour -> Daily
    else if tfInMinutes < 1440
        result := "D"       // Less than daily -> Daily
    else if baseTF == "D"
        result := "W"       // Daily -> Weekly
    else if baseTF == "W"
        result := "M"       // Weekly -> Monthly
    else
        result := "M"       // Default to Monthly

    result

// Get second higher timeframe
getSecondHigherTimeframe(baseTF) =>
    firstHTF = getHigherTimeframe(baseTF)
    getHigherTimeframe(firstHTF)

// Auto-detect or use manual timeframes
higherTF1 = manualHTF1 == "" ? getHigherTimeframe(currentTF) : manualHTF1
higherTF2 = manualHTF2 == "" ? getSecondHigherTimeframe(currentTF) : manualHTF2

// ============================= CALCULATIONS =================================

// CURRENT TIMEFRAME ANALYSIS
currentVolume = volume
currentAvgVolume = ta.sma(volume, volumeLookback)
currentRelVol = currentVolume / currentAvgVolume

// HIGHER TIMEFRAME 1 ANALYSIS
[htf1Volume, htf1AvgVolume] = request.security(
     syminfo.tickerid,
     higherTF1,
     [volume, ta.sma(volume, volumeLookback)],
     lookahead=barmerge.lookahead_off
     )
htf1RelVol = htf1Volume / htf1AvgVolume

// HIGHER TIMEFRAME 2 ANALYSIS
[htf2Volume, htf2AvgVolume] = request.security(
     syminfo.tickerid,
     higherTF2,
     [volume, ta.sma(volume, volumeLookback)],
     lookahead=barmerge.lookahead_off
     )
htf2RelVol = htf2Volume / htf2AvgVolume

// ============================= SCORING ======================================

// 1. VOLUME CONVERGENCE SCORE (0-40 points)
convergenceScore = 0.0

// All three timeframes above threshold (40 points)
if currentRelVol > volumeThreshold1 and htf1RelVol > volumeThreshold2 and htf2RelVol > volumeThreshold3
    convergenceScore := 40.0
// At least two timeframes elevated (25 points)
else if (currentRelVol > volumeThreshold1 and htf1RelVol > volumeThreshold2) or
        (htf1RelVol > volumeThreshold2 and htf2RelVol > volumeThreshold3) or
        (currentRelVol > volumeThreshold1 and htf2RelVol > volumeThreshold3)
    convergenceScore := 25.0
// Only one timeframe elevated (10 points)
else if currentRelVol > volumeThreshold1 or htf1RelVol > volumeThreshold2 or htf2RelVol > volumeThreshold3
    convergenceScore := 10.0

// 2. VOLUME PATTERN SCORE - Building Campaign (0-20 points)
// Increasing volume pattern: HTF2 > HTF1 > Current suggests building campaign
volumePatternScore = 0.0
if htf2RelVol > htf1RelVol and htf1RelVol > currentRelVol and convergenceScore > 20
    volumePatternScore := 20.0
else if htf2RelVol > htf1RelVol or htf1RelVol > currentRelVol
    volumePatternScore := 10.0

// 3. PRICE ACTION CONFIRMATION (0-30 points)
// Check if price is ranging (accumulation) vs trending (distribution)
currentRange = (high - low) / close
avgRange = ta.sma(currentRange, volumeLookback)
rangeRatio = currentRange / avgRange

priceScore = 0.0
patternLabel = ""

// High volume + tight range = accumulation
if rangeRatio < (1.0 + divergenceThreshold) and convergenceScore > 20
    priceScore := 30.0
    patternLabel := "Accumulation"
// High volume + wide range = distribution or breakout
else if rangeRatio > (1.0 + divergenceThreshold) and convergenceScore > 20
    priceScore := 20.0
    patternLabel := "Distribution/Breakout"
else
    patternLabel := "Neutral"

// 4. TREND CONFIRMATION (0-10 points)
// Check if higher timeframes show trend alignment
htf1Close = request.security(syminfo.tickerid, higherTF1, close, lookahead=barmerge.lookahead_off)
htf1SMA = request.security(syminfo.tickerid, higherTF1, ta.sma(close, trendLength), lookahead=barmerge.lookahead_off)
htf1Trend = htf1Close > htf1SMA

trendScore = htf1Trend and convergenceScore > 20 ? 10.0 : 0.0

// 5. FINAL MTF SCORE (0-100)
mtfScore = math.min(100, convergenceScore + volumePatternScore + priceScore + trendScore)
isInstitutional = mtfScore >= scoreThreshold

// ============================= BACKTESTING ==================================

var int totalSignals = 0
var int wins5 = 0
var int wins20 = 0
var float totalReturn5 = 0.0
var float totalReturn20 = 0.0

if enableBacktest and isInstitutional
    totalSignals += 1

    if bar_index < (last_bar_index - 20)
        forwardReturn5 = (close[5] - close) / close * 100
        forwardReturn20 = (close[20] - close) / close * 100

        totalReturn5 += forwardReturn5
        totalReturn20 += forwardReturn20

        if forwardReturn5 > 2.0
            wins5 += 1
        if forwardReturn20 > 5.0
            wins20 += 1

winRate5 = totalSignals > 0 ? (wins5 / totalSignals) * 100 : 0.0
winRate20 = totalSignals > 0 ? (wins20 / totalSignals) * 100 : 0.0
avgReturn5 = totalSignals > 0 ? totalReturn5 / totalSignals : 0.0
avgReturn20 = totalSignals > 0 ? totalReturn20 / totalSignals : 0.0

// ============================= VISUALIZATION ================================

// Color gradient
scoreColor = mtfScore >= 70 ? color.new(color.green, 0) :
             mtfScore >= 50 ? color.new(color.yellow, 0) :
             mtfScore >= 30 ? color.new(color.orange, 0) : color.new(color.red, 0)

// Main MTF score histogram
plot(mtfScore, "MTF Score", color=scoreColor, style=plot.style_histogram, linewidth=3)

// Relative volume plots for each timeframe
plot(showVolumePlots ? currentRelVol * 20 : na, "Current TF Vol", color=color.new(color.blue, 30), linewidth=2)
plot(showVolumePlots ? htf1RelVol * 20 : na, "HTF1 Vol", color=color.new(color.purple, 30), linewidth=2)
plot(showVolumePlots ? htf2RelVol * 20 : na, "HTF2 Vol", color=color.new(color.fuchsia, 30), linewidth=2)

// Reference lines
hline(scoreThreshold, "Threshold", color=color.new(color.white, 50), linestyle=hline.style_dashed, linewidth=1)
hline(50, "Midline", color=color.new(color.gray, 70), linestyle=hline.style_dotted)
hline(30, "Volume Ref (1.5x)", color=color.new(color.gray, 80), linestyle=hline.style_dotted)

// Chart markers
plotshape(showMarkers and isInstitutional and patternLabel == "Accumulation" ? mtfScore : na,
     "Accumulation", shape.circle, location.bottom, color.new(color.green, 0), size=size.small)
plotshape(showMarkers and isInstitutional and patternLabel == "Distribution/Breakout" ? mtfScore : na,
     "Distribution", shape.circle, location.top, color.new(color.red, 0), size=size.small)

// Background tint
bgcolor(isInstitutional ? color.new(scoreColor, 90) : na)

// ============================= INFO TABLE ===================================

if showTable
    var table infoTable = table.new(position.top_right, 2, 14, border_width=1)

    if barstate.islast
        // Header
        table.cell(infoTable, 0, 0, "MTF Convergence Analysis", text_color=color.white, bgcolor=color.new(color.blue, 30), text_size=size.normal)
        table.merge_cells(infoTable, 0, 0, 1, 0)

        // Current Status
        table.cell(infoTable, 0, 1, "MTF Score:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        table.cell(infoTable, 1, 1, str.tostring(math.round(mtfScore, 0)),
             text_color=color.white, bgcolor=color.new(scoreColor, 50), text_size=size.small)

        table.cell(infoTable, 0, 2, "Pattern:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        table.cell(infoTable, 1, 2, patternLabel,
             text_color=color.white, bgcolor=color.new(scoreColor, 50), text_size=size.small)

        table.cell(infoTable, 0, 3, "Trend:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.small)
        table.cell(infoTable, 1, 3, htf1Trend ? "Bullish" : "Bearish",
             text_color=htf1Trend ? color.lime : color.red,
             bgcolor=color.new(color.gray, 70), text_size=size.small)

        // Timeframes Section
        table.cell(infoTable, 0, 4, "Timeframes:", text_color=color.yellow, bgcolor=color.new(color.gray, 70), text_size=size.small)
        table.merge_cells(infoTable, 0, 4, 1, 4)

        // Current TF
        tfLabel = currentTF
        currentCheck = currentRelVol > volumeThreshold1 ? "✓" : "✗"
        table.cell(infoTable, 0, 5, "Current (" + tfLabel + "):", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        table.cell(infoTable, 1, 5, currentCheck + " " + str.tostring(currentRelVol, "#.#") + "x",
             text_color=currentRelVol > volumeThreshold1 ? color.lime : color.gray,
             bgcolor=color.new(color.gray, 80), text_size=size.small)

        // HTF1
        htf1Check = htf1RelVol > volumeThreshold2 ? "✓" : "✗"
        table.cell(infoTable, 0, 6, "HTF1 (" + higherTF1 + "):", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        table.cell(infoTable, 1, 6, htf1Check + " " + str.tostring(htf1RelVol, "#.#") + "x",
             text_color=htf1RelVol > volumeThreshold2 ? color.lime : color.gray,
             bgcolor=color.new(color.gray, 80), text_size=size.small)

        // HTF2
        htf2Check = htf2RelVol > volumeThreshold3 ? "✓" : "✗"
        table.cell(infoTable, 0, 7, "HTF2 (" + higherTF2 + "):", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        table.cell(infoTable, 1, 7, htf2Check + " " + str.tostring(htf2RelVol, "#.#") + "x",
             text_color=htf2RelVol > volumeThreshold3 ? color.lime : color.gray,
             bgcolor=color.new(color.gray, 80), text_size=size.small)

        // Score Components
        table.cell(infoTable, 0, 8, "Score Breakdown:", text_color=color.yellow, bgcolor=color.new(color.gray, 70), text_size=size.small)
        table.merge_cells(infoTable, 0, 8, 1, 8)

        table.cell(infoTable, 0, 9, "Convergence:", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        table.cell(infoTable, 1, 9, str.tostring(convergenceScore, "#"), text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)

        table.cell(infoTable, 0, 10, "Pattern:", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        table.cell(infoTable, 1, 10, str.tostring(volumePatternScore, "#"), text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)

        table.cell(infoTable, 0, 11, "Price Action:", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
        table.cell(infoTable, 1, 11, str.tostring(priceScore, "#"), text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)

        // Backtest Results
        if enableBacktest
            table.cell(infoTable, 0, 12, "Win Rate (5/20):", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
            table.cell(infoTable, 1, 12, str.tostring(winRate5, "#") + "% / " + str.tostring(winRate20, "#") + "%",
                 text_color=winRate5 > 60 ? color.lime : color.orange,
                 bgcolor=color.new(color.gray, 80), text_size=size.small)

            table.cell(infoTable, 0, 13, "Total Signals:", text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)
            table.cell(infoTable, 1, 13, str.tostring(totalSignals), text_color=color.white, bgcolor=color.new(color.gray, 80), text_size=size.small)

// ============================= DEBUG TABLE ==================================

if debugMode
    var table debugTable = table.new(position.bottom_right, 2, 8, border_width=1)

    if barstate.islast
        table.cell(debugTable, 0, 0, "DEBUG: MTF Data", text_color=color.black, bgcolor=color.yellow, text_size=size.small)
        table.merge_cells(debugTable, 0, 0, 1, 0)

        table.cell(debugTable, 0, 1, "Current Vol:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
        table.cell(debugTable, 1, 1, str.tostring(currentVolume, "#"), text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)

        table.cell(debugTable, 0, 2, "HTF1 Vol:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
        table.cell(debugTable, 1, 2, str.tostring(htf1Volume, "#"), text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)

        table.cell(debugTable, 0, 3, "HTF2 Vol:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
        table.cell(debugTable, 1, 3, str.tostring(htf2Volume, "#"), text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)

        table.cell(debugTable, 0, 4, "Range Ratio:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
        table.cell(debugTable, 1, 4, str.tostring(rangeRatio, "#.##"), text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)

        table.cell(debugTable, 0, 5, "Avg Return 5:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
        table.cell(debugTable, 1, 5, str.tostring(avgReturn5, "#.##") + "%",
             text_color=avgReturn5 > 0 ? color.lime : color.red,
             bgcolor=color.new(color.gray, 70), text_size=size.tiny)

        table.cell(debugTable, 0, 6, "Avg Return 20:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
        table.cell(debugTable, 1, 6, str.tostring(avgReturn20, "#.##") + "%",
             text_color=avgReturn20 > 0 ? color.lime : color.red,
             bgcolor=color.new(color.gray, 70), text_size=size.tiny)

        table.cell(debugTable, 0, 7, "Convergence:", text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)
        convergeText = convergenceScore == 40 ? "All 3 TF" : convergenceScore == 25 ? "2 TF" : convergenceScore == 10 ? "1 TF" : "None"
        table.cell(debugTable, 1, 7, convergeText, text_color=color.white, bgcolor=color.new(color.gray, 70), text_size=size.tiny)

// ============================= ALERTS =======================================

alertcondition(ta.crossover(mtfScore, scoreThreshold),
     "MTF Convergence Detected",
     "MULTI-TIMEFRAME: Institutional " + patternLabel + " detected on {{ticker}} (Score: " + str.tostring(mtfScore, "#") + ")")

alertcondition(ta.crossunder(mtfScore, scoreThreshold),
     "MTF Convergence Ended",
     "MTF institutional activity ended on {{ticker}}")

// High confidence alert - all 3 timeframes aligned
alertcondition(convergenceScore == 40 and mtfScore > scoreThreshold and not (mtfScore[1] > scoreThreshold),
     "All Timeframes Aligned",
     "VERY HIGH CONFIDENCE: All 3 timeframes show institutional activity on {{ticker}} (" + patternLabel + ")")
